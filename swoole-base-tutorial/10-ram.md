# 常驻内存以及如何避免内存泄露

## 传统 Web
* 每一次 PHP 请求都需经过：
    * 磁盘读取、初始化、词法解析、语法解析、编译。
    * nginx || apache 通信。
    * 数据库交互、握手、检权、关闭等操作。
    * 在一次请求结束前，内存和资源都会得到释放。

## Swoole
* Swoole 常驻内存。
* 运行 server 之后加载的任何资源都会一直在内存中。
* 包括加载文件配置、初始化变量等操作。
* 由于常驻内存不会再请求结束前释放，没操作好就会内存泄露。

## 全局变量
* global 声明的变量、static 声明的对象属性、函数内的静态变量、超全局变量。
* 在多进程开发模式下，进程内的全局变量所用的内存也是保存在子进程内存堆的，也非共享内存，所以需要尽量避免使用全局变量。

## 解决方法
* 可以使用 `max_request`、`task_max_request` 来避免内存溢出。
* max_request 表示 Worker 进程的最大任务数，当任务数超过这个参数，进程会自动退出释放内存。
* Manager 进程会自动重新启动一个新的 Worker 进程。

## 场景限制
* `max_request` 只能用于同步阻塞、无状态的请求响应式服务器程序。
* 纯异步的 Server 不应当设置 `max_request`。
* 使用 Base 模式时 `max_request` 是无效的。
